#[
    This script header is a part of RailDriver.

    RailDriver. Smart Locomotive Control script for Garry's Mod Train Build Servers.
    Copyright Â© 2022, Cassandra "ZZ Cat" Robinson. All rights reserved.

    This E2 script is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as
    published by the Free Software Foundation, either version 3 of the
    License, or (at your option) any later version.

    This E2 script is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with this E2 script.  If not, see <https://www.gnu.org/licenses/>.
]#

@name RailDriver/lib/ota/online

#[
    Online OTA Updates library for RailDriver.

    This library is used to check for updates to RailDriver and download them.
]#

# This function initializes the Online OTA Updates library.
# @return The handle to the Online OTA Updates library.
function table otaOnlineInit()
{
    local Ota = table()

    Ota["Clock ID", string] = "RailDriver OTA Online Clock"
    Ota["Clock Delay", number] = 0

    # The selected URL to download the update from.
    Ota["URL to Get", string] = ""

    return Ota
}

# This function compiles the URL to the online Version File & starts the online OTA update process.
# @param OtaOnline The handle to the Online OTA Updates library.
# @param OtaLocal The handle to the Local OTA Updates library.
# @return true if the online OTA update process started successfully, false otherwise.
function number otaOnlineUpdateRailDriver(OtaOnline:table, OtaLocal:table)
{
    # Return an empty string if the local Version File is not valid.
    if (OtaLocal["Flags", table]["Version File is Valid", number] != 1 | OtaLocal:count() == 0 | OtaLocal["RailDriver", table]:count() == 0)
    {
        return 0
    }

    # Compile the URL to RailDriver's online Version File.
    local BaseURL = "https://raw.githubusercontent.com/"
    local Username = ""
    local Repository = ""
    local Branch = ""
    local Path = ""
    local File = ""
    local URL = ""

    Username = OtaLocal["RailDriver", table]["Developers", table]["Owner", table]["Social", table]["GitHub", table]["Username", string]
    Repository = OtaLocal["RailDriver", table]["Main", table]["File", string]:explode(".")[1, string]
    Branch = "Over-The-Air-Updates_Part-2-of-2_Online"
    Path = OtaLocal["RailDriver", table]["Libraries", table]["Over-The-Air Updates", table]["Online", table]["Path", string]
    File = "version.json"

    # Remove "e2shared/RailDriver/" from the Path.
    local PathPartsToReplace = "e2shared/RailDriver/"
    Path = Path:sub(PathPartsToReplace:length() + 1, Path:length())

    # Compile the URL.
    OtaOnline["URL to Get", string] = BaseURL + Username + "/" + Repository + "/" + Branch + "/" + Path + "/" + File

    return 1
}

function void otaOnlineRequestHandler(Ota:table)
{}
